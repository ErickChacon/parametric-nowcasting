---
title: "SARI: Compare growth curves"
prerequisites:
    - data/processed/sari_cum_2009_06_14_to_11_22.rds
targets:
    - data/figures/sari_qd_comparison.png
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
knitr::opts_chunk$set(fig.height = 6, fig.width = 8, out.width = "100%")
knitr::opts_chunk$set(comment = "#>")
options(width = 100)
```

## Load packages, scripts and data

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(latex2exp)

path_proj <- here::here()
path_src <- file.path(path_proj, "src")
path_data <- file.path(path_proj, "data")
path_cleaned <- file.path(path_data, "cleaned")
path_processed <- file.path(path_data, "processed")
path_figures <- file.path(path_data, "figures")

source(file.path(path_src, "process-data.R"))
source(file.path(path_src, "explore-data.R"))

sari <- readRDS(file.path(path_processed, "sari_cum_2009_06_14_to_11_22.rds"))
```

## Convert to long format

Convert data to long format and filter with observed data by the last available date.

```{r}
last_date <- max(sari$date)
sari_long <- sari |>
    select(-starts_with("notifications")) |>
    reporcases_longer() |>
    mutate(available_delay = floor(as.numeric(last_date - date) / 7 )) |>
    filter(delay <= available_delay)
```

## Fit Exponential and Gompertz curves

We will compare the exponential and Gompertz growth curves assuming a time-invariant
reporting probability in the period of time between `2009-07-19` and `2009-09-06`.

```{r}
# prepare the data to train
somedates <- seq(as.Date("2009-07-19"), as.Date("2009-09-06"), "1 week")
df_train <- filter(sari_long, date %in% somedates) |>
    mutate(date = factor(date))
df_fit <- data.frame(delay = seq(0, max(df_train$delay), length = 100))

# initial values
max_cases <- group_by(df_train, date) |>
    summarise(cases = max(cases)) |>
    pull(cases)

# fit models
mod_gomp <- nls(
    cases ~ exp(logN[date]) * exp(logphi*exp(-b * delay)),
    data = df_train,
    start = list(b = 0.5, logphi = log(0.05), logN = log(max_cases))
)
mod_exp <- nls(
    cases ~ exp(logN[date]) * (1 - (1 - plogis(logitphi))* exp(-b * delay)),
    data = df_train,
    start = list(b = 0.5, logitphi = qlogis(0.1), logN = log(max_cases))
)

# summarise
list(Exponential = mod_exp, Gompertz = mod_gomp) |>
    sapply(function(x) c(AIC = AIC(x), BIC = BIC(x), SSE = deviance(x))) |>
    data.frame()
```

## Visualize standardised fitted curves

Let's obtain the curves with the estimated parameter for each model.

```{r}
# predict
df_train <- df_train |>
    mutate(gomp_total = exp(coef(mod_gomp)[-(1:2)])[as.integer(df_train$date)],
           gomp_q = cases / gomp_total,
           exp_total = exp(coef(mod_exp)[-(1:2)])[as.integer(df_train$date)],
           exp_q = cases / exp_total
    ) |>
    pivot_longer(gomp_total:exp_q, names_to = c("model", "var"), names_pattern = "(.*)_(.*)") |>
    pivot_wider(names_from = var, values_from = value)

df_fit <- df_fit |>
    mutate(gomp_q = exp(coef(mod_gomp)["logphi"] * exp(-coef(mod_gomp)["b"] * delay)),
           exp_q = 1 - (1 - plogis(coef(mod_exp)["logitphi"])) * exp(-coef(mod_exp)["b"] * delay)
    ) |>
    pivot_longer(gomp_q:exp_q, names_to = c("model"), values_to = "q",
                 names_transform = function(x) sub("_q", "", x)
    )
```

Visualize the estimated theoretical curves using the exponential and Gompertz models.

```{r, fig.height = 3.2}
mylabs <- c("exp" = "(a) Exponential", "gomp" = "(b) Gompertz")

p <- ggplot(df_train) +
    geom_line(aes(delay, q, group = date), color = "gray", linewidth = rel(0.3)) +
    geom_point(aes(delay, q, group = date, color = "Empirical"), size = rel(0.5)) +
    geom_line(aes(delay, q, color = "Theoretical"), df_fit, linewidth = rel(0.5),
              linetype = "dashed") +
    labs(title = NULL, y = TeX("$q(d)$"), x = TeX("$d$"), color = NULL) +
    facet_wrap(~ model, scales = "free", labeller = as_labeller(mylabs)) +
    theme_classic(9) +
    scale_colour_manual(values = c("gray30", "red")) +
    theme(
        legend.position = c(0.9, 0.15),
        strip.background = element_blank(),
        strip.text = element_text(face = "bold")
    )
p
ggsave(file.path(path_figures, "sari_qd_comparison.png"), p,
       width = 20 * 8/ 20, height = 8 * 8 / 20, dpi = 300)
```

## Time to execute the task

Only useful when executed with `Rscript`.

```{r}
proc.time()
```

